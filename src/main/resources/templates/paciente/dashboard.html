<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Paciente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">

<h2>Bienvenido, <span th:text="${paciente.name}"></span></h2>

<!-- Tabs -->
<ul class="nav nav-tabs" id="pacienteTabs" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" id="misCitas-tab" data-bs-toggle="tab" href="#misCitas" role="tab">Mis Citas</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="nuevaCita-tab" data-bs-toggle="tab" href="#nuevaCita" role="tab">Nueva Cita</a>
    </li>
</ul>

<div class="tab-content mt-3">
    <!-- ðŸ”¹ Mis Citas -->
    <div class="tab-pane fade show active" id="misCitas" role="tabpanel">
        <h4>Mis Citas</h4>
        <table class="table table-bordered">
            <thead>
            <tr>
                <th>Doctor</th>
                <th>Especialidad</th>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Acciones</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="cita : ${citas}">
                <td th:text="${cita.doctor.name}"></td>
                <td th:text="${cita.doctor.especialidad}"></td>
                <td th:text="${cita.disponibilidad.fecha}"></td>
                <td th:text="${cita.disponibilidad.horaInicio}"></td>
                <td th:text="${cita.disponibilidad.horaFin}"></td>
                <td>
                    <form th:action="@{/citasmedicas/paciente/citas/cancelar/{id}(id=${cita.id})}" method="post">
                        <button type="submit" class="btn btn-danger btn-sm">Cancelar</button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- ðŸ”¹ Nueva Cita -->
    <div class="tab-pane fade" id="nuevaCita" role="tabpanel">
        <h4>Agendar Nueva Cita</h4>
        <form th:action="@{/citasmedicas/paciente/citas/agendar}" method="post">
            <div class="mb-3">
                <label>Especialidad</label>
                <select id="especialidad" name="especialidad" class="form-select">
                    <option value="">Seleccione especialidad</option>
                    <option th:each="esp : ${especialidades}" th:value="${esp}" th:text="${esp}"></option>
                </select>
            </div>

            <div class="mb-3">
                <label>Doctor</label>
                <select id="doctor" name="doctorId" class="form-select">
                    <option value="">Seleccione doctor</option>
                </select>
            </div>

            <div class="mb-3">
                <label>Disponibilidad</label>
                <select id="disponibilidad" name="disponibilidadId" class="form-select">
                    <option value="">Seleccione disponibilidad</option>
                </select>
            </div>

            <button type="submit" class="btn btn-primary">Agendar Cita</button>
        </form>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    async function cargarDoctores() {
        const especialidad = document.getElementById("especialidad").value;
        const doctorSelect = document.getElementById("doctor");
        doctorSelect.innerHTML = "<option value=''>Seleccione un doctor</option>";

        if (!especialidad) return;

        try {
            const resp = await fetch(`/citasmedicas/paciente/doctores?especialidad=${encodeURIComponent(especialidad)}`);
            if (!resp.ok) throw new Error(`Error HTTP ${resp.status}`);
            const doctores = await resp.json();
            console.log('doctores:', doctores);

            doctores.forEach(doc => {
                const opt = document.createElement("option");
                opt.value = doc.id;
                // Fallbacks para el nombre (segÃºn cÃ³mo serialice tu backend)
                const nombre = doc.name ?? doc.nombre ?? doc.email ?? 'Doctor';
                // Mostrar tambiÃ©n la especialidad si viene (puede venir como objeto enum)
                const esp = (doc.especialidad && (doc.especialidad.name ?? doc.especialidad)) ? ` (${doc.especialidad.name ?? doc.especialidad})` : '';
                opt.textContent = nombre + esp;
                doctorSelect.appendChild(opt);
            });

            // Opcional: seleccionar el primer doctor automÃ¡ticamente y cargar disponibilidades
            if (doctorSelect.options.length > 1) {
                doctorSelect.selectedIndex = 1;
                cargarDisponibilidades();
            }
        } catch (err) {
            console.error(err);
            alert('No se pudieron cargar los doctores: ' + err.message);
        }
    }

    async function cargarDisponibilidades() {
        const doctorId = document.getElementById("doctor").value;
        const dispSelect = document.getElementById("disponibilidad");
        dispSelect.innerHTML = "<option value=''>Seleccione una fecha y hora</option>";

        if (!doctorId) return;

        try {
            const resp = await fetch(`/citasmedicas/paciente/disponibilidades?doctorId=${encodeURIComponent(doctorId)}`);
            if (!resp.ok) throw new Error(`Error HTTP ${resp.status}`);
            const disponibilidades = await resp.json();
            console.log('disponibilidades:', disponibilidades);

            disponibilidades.forEach(d => {
                const opt = document.createElement("option");
                opt.value = d.id;
                // Manejar distintas formas en que puede venir la fecha/hora
                const fecha = d.fecha ?? d.fechaHora ?? d.date ?? '';
                const hora = d.hora ?? (d.horaInicio && d.horaFin ? `${d.horaInicio} - ${d.horaFin}` : d.horaInicio) ?? '';
                opt.textContent = `${fecha} ${hora}`.trim() || 'Horario';
                dispSelect.appendChild(opt);
            });
        } catch (err) {
            console.error(err);
            alert('No se pudieron cargar las disponibilidades: ' + err.message);
        }
    }
</script>

<script>
    document.getElementById("especialidad").addEventListener("change", function() {
        let esp = this.value;
        if (esp) {
            fetch("/citasmedicas/paciente/doctores?especialidad=" + esp)
                .then(res => res.text())
                .then(html => {
                    document.getElementById("doctor").innerHTML = html;
                    document.getElementById("disponibilidad").innerHTML = "<option value=''>Seleccione disponibilidad</option>";
                });
        }
    });

    document.getElementById("doctor").addEventListener("change", function() {
        let doctorId = this.value;
        if (doctorId) {
            fetch("/citasmedicas/paciente/disponibilidades?doctorId=" + doctorId)
                .then(res => res.text())
                .then(html => {
                    document.getElementById("disponibilidad").innerHTML = html;
                });
        }
    });
</script>


</body>
</html>

